CREATE TABLE policy_chunks (

    chunk_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    project TEXT NOT NULL,
    branch  TEXT DEFAULT 'main',
    file_path TEXT,
    file_version TEXT,
    policy_version TEXT NOT NULL,
    xml_path TEXT,

    mpu_name TEXT NOT NULL,
    rg_index INT  NOT NULL,
    profile  TEXT,

    policy_id    TEXT,
    policy_title TEXT,

    start_dec BIGINT,
    end_dec   BIGINT,
    start_hex TEXT,
    end_hex   TEXT,

    rdomains TEXT[],
    wdomains TEXT[],
    rvmids   TEXT[],
    wvmids   TEXT[],

    static    BOOLEAN,
    confirmed BOOLEAN,
    enabled   BOOLEAN,

    raw_xml  TEXT NOT NULL,
    xml_hash TEXT NOT NULL,

    is_active BOOLEAN NOT NULL DEFAULT true,
    supersedes_chunk_id UUID NULL,

    weaviate_object_id UUID UNIQUE NOT NULL,

    created_at TIMESTAMP DEFAULT NOW(),

    UNIQUE (project, branch, mpu_name, rg_index, profile, policy_version)
);

CREATE INDEX idx_active_policy
ON policy_chunks(project, branch, mpu_name, rg_index, profile)
WHERE is_active = true;

CREATE INDEX idx_project_mpu
ON policy_chunks(project, mpu_name);

CREATE INDEX idx_addr_range
ON policy_chunks(start_dec, end_dec);

CREATE INDEX idx_weaviate_id
ON policy_chunks(weaviate_object_id);

CREATE INDEX idx_xml_hash
ON policy_chunks(xml_hash);












export PG_HOST=localhost
export PG_DB=ragdb
export PG_USER=raguser
export PG_PASSWORD=ragpass
export WEAVIATE_URL=http://localhost:8080
export POLICY_VERSION=v1.0    # change per ingestion


class PropagateRequest(BaseModel):
    parent_project: str
    child_project: str
    mpu_name: Optional[str] = None   # null = all MPUs


def pg_get_active_policies(project: str, mpu_name: Optional[str] = None):
    sql = """
    SELECT *
    FROM policy_chunks
    WHERE project = %s
      AND is_active = true
      AND (%s IS NULL OR mpu_name = %s)
    ORDER BY mpu_name, rg_index, profile;
    """

    params = (project, mpu_name, mpu_name)
    return pg_fetch_rows(sql, params)


def logical_key(row: Dict[str, Any]):
    """
    Logical policy identity for propagation & diff.
    """
    return (row["mpu_name"], row["rg_index"], row.get("profile"))


@app.post("/propagate")
def propagate_policies(req: PropagateRequest):
    """
    Parent → Child policy propagation planner.

    Returns:
      - propagate_missing : policies present in parent but missing in child
      - propagate_review  : policies present in both but with different rules
    """

    parent_rows = pg_get_active_policies(req.parent_project, req.mpu_name)
    child_rows  = pg_get_active_policies(req.child_project,  req.mpu_name)

    parent_map = {logical_key(r): r for r in parent_rows}
    child_map  = {logical_key(r): r for r in child_rows}

    propagate_missing = []
    propagate_review  = []

    compare_fields = [
        "start_dec",
        "end_dec",
        "rdomains",
        "wdomains",
        "rvmids",
        "wvmids",
        "static",
        "confirmed",
        "enabled",
    ]

    for key, parent_row in parent_map.items():
        child_row = child_map.get(key)

        # -----------------------------
        # Case 1: Missing in Child → MUST PROPAGATE
        # -----------------------------
        if not child_row:
            propagate_missing.append(
                {
                    "mpu_name": parent_row["mpu_name"],
                    "rg_index": parent_row["rg_index"],
                    "profile": parent_row.get("profile"),
                    "parent_policy": parent_row,
                }
            )
            continue

        # -----------------------------
        # Case 2: Exists in both → CHECK FOR DIFFERENCES
        # -----------------------------
        diffs = {}
        for f in compare_fields:
            if parent_row[f] != child_row[f]:
                diffs[f] = {
                    req.parent_project: parent_row[f],
                    req.child_project:  child_row[f],
                }

        if diffs:
            propagate_review.append(
                {
                    "mpu_name": parent_row["mpu_name"],
                    "rg_index": parent_row["rg_index"],
                    "profile": parent_row.get("profile"),
                    "diffs": diffs,
                    "parent_policy": parent_row,
                    "child_policy": child_row,
                }
            )

    return {
        "parent_project": req.parent_project,
        "child_project": req.child_project,
        "mpu_name": req.mpu_name,
        "propagate_missing": propagate_missing,
        "propagate_review": propagate_review,
        "summary": {
            "missing_count": len(propagate_missing),
            "review_count": len(propagate_review),
        },
    }

