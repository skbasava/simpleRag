filters = {
    "candidate_chunk_ids": [12, 47, 103, 208],
    "project": "KAANAPALLI",
    "version": "latest",
    "mpu_name": None,
    "region": None,
    "query_address": 0xC210000,
}

output expected 

SELECT ...
FROM policy_chunks
WHERE id = ANY(%(candidate_chunk_ids)s)
  AND project = %(project)s
  AND version = (
        SELECT MAX(version)
        FROM policy_chunks
        WHERE project = %(project)s
  )
  AND addr_start <= %(query_address)s
  AND addr_end >= %(query_address)s

{
  "candidate_chunk_ids": [12, 47, 103, 208],
  "project": "KAANAPALLI",
  "query_address": 0xC210000
}










def build_policy_sql(filters: dict) -> tuple[str, dict]:
    """
    Build a safe, parameterized SQL query for policy retrieval.

    Expected filters keys:
      - candidate_chunk_ids: list[int] (REQUIRED)
      - project: str | None
      - version: str | "latest" | None
      - mpu_name: str | None
      - region: int | None
      - query_address: int | None

    Returns:
      (sql_query, sql_params)
    """

    if not filters.get("candidate_chunk_ids"):
        raise ValueError("candidate_chunk_ids is required for SQL filtering")

    where_clauses = []
    params = {}

    # --- Candidate gating (mandatory) ---
    where_clauses.append("id = ANY(%(candidate_chunk_ids)s)")
    params["candidate_chunk_ids"] = filters["candidate_chunk_ids"]

    # --- Project ---
    if filters.get("project"):
        where_clauses.append("project = %(project)s")
        params["project"] = filters["project"]

    # --- Version ---
    version = filters.get("version")
    if version and version != "latest":
        where_clauses.append("version = %(version)s")
        params["version"] = version
    elif version == "latest":
        where_clauses.append(
            "version = (SELECT MAX(version) FROM policy_chunks WHERE project = %(project)s)"
        )
        params["project"] = filters.get("project")

    # --- MPU ---
    if filters.get("mpu_name"):
        where_clauses.append("mpu_name = %(mpu_name)s")
        params["mpu_name"] = filters["mpu_name"]

    # --- Region ---
    if filters.get("region") is not None:
        where_clauses.append("rg_index = %(region)s")
        params["region"] = filters["region"]

    # --- Address containment ---
    if filters.get("query_address") is not None:
        where_clauses.append(
            "(addr_start <= %(query_address)s AND addr_end >= %(query_address)s)"
        )
        params["query_address"] = filters["query_address"]

    # --- Final SQL ---
    sql = f"""
        SELECT
            id,
            project,
            version,
            mpu_name,
            rg_index,
            addr_start,
            addr_end,
            raw_text,
            embedding
        FROM policy_chunks
        WHERE {" AND ".join(where_clauses)}
    """

    return sql.strip(), params