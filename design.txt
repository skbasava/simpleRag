
def _apply_version(self):
    version = self.filters.get("version")

    if version:
        self.conditions.append("version = %s")
        self.params.append(version)
        return

    # Version not provided â†’ resolve latest
    project = self.filters.get("project")
    if project and self.version_resolver:
        resolved = self.version_resolver(project)
        if resolved:
            self.conditions.append("version = %s")
            self.params.append(resolved)


def _sql_search(self, params: dict) -> list[dict]:
    """
    Executes deterministic SQL path and enriches rows with
    classification + explainability.
    """
    logger.info(
        "Entering _sql_search with params: %s",
        _safe_params_for_log(params)
    )

    facts = QueryFacts(**params)

    # ---- Run SQL path ----
    rows = self.run_sql_path(facts)

    if not rows:
        logger.info("SQL returned no rows")
        return []

    # ---- Enrich rows (pure functions) ----
    enriched = []
    for row in rows:
        # classification
        cls = classify_policy(
            row["addr_start"],
            row["addr_end"],
            row.get("profile"),
        )
        row.update(cls)

        # explainability
        if facts.addr_start is not None:
            row["explanation"] = explain_region_choice(
                row=row,
                query_start=facts.addr_start,
                query_end=facts.addr_end,
            )

        enriched.append(row)

    return enriched