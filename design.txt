
-- Drop vector + chunk tables explicitly

DROP TABLE IF EXISTS xml_chunks CASCADE;
DROP TABLE IF EXISTS ingestion_progress CASCADE;

-- If you created auxiliary tables
DROP TABLE IF EXISTS rag_jobs CASCADE;
DROP TABLE IF EXISTS rag_logs CASCADE;


#!/usr/bin/env bash
set -e

echo "=============================="
echo "RAG SYSTEM â€“ FULL CLEAN & REBUILD"
echo "=============================="

echo ""
echo "ğŸ”» Step 1: Stop containers"
docker compose down --remove-orphans

echo ""
echo "ğŸ—‘ï¸  Step 2: Remove volumes (Postgres data)"
docker compose down -v

echo ""
echo "ğŸŒ Step 3: Remove project networks"
docker network prune -f

echo ""
echo "ğŸ§¹ Step 4: Remove dangling images"
docker image prune -f

echo ""
echo "ğŸ”¨ Step 5: Rebuild images (no cache)"
docker compose build --no-cache

echo ""
echo "ğŸš€ Step 6: Start Postgres only"
docker compose up -d postgres

echo "â³ Waiting for Postgres to be ready..."
sleep 8

echo ""
echo "ğŸ§¨ Step 7: Drop Postgres tables"
docker compose exec -T postgres \
  psql -U postgres -d ragdb -f /cleanup_postgres.sql

echo ""
echo "ğŸš€ Step 8: Start all services"
docker compose up -d

echo ""
echo "âœ… Rebuild complete"
docker compose ps


ADDRESS_RANGE_RE = re.compile(
    r"(0x[0-9A-Fa-f]+)\s*-\s*(0x[0-9A-Fa-f]+)"
)

def extract_address_range(text: str):
    m = ADDRESS_RANGE_RE.search(text)
    if not m:
        return None, None
    return m.group(1), m.group(2)
